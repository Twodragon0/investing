name: Push Folder Info To Slack

on:
  workflow_run:
    workflows: ["Generate Daily Summary"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  push-folder-info:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    strategy:
      fail-fast: false
      matrix:
        channel_alias: [ops, dev, security, ai, investing]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout investing
        uses: actions/checkout@v4
        with:
          repository: Twodragon0/investing
          path: investing
          fetch-depth: 1

      - name: Build folder summary
        id: summary
        shell: bash
        run: |
          set -euo pipefail

          build_line() {
            local repo_name="$1"
            local repo_path="$2"

            if ! git -C "$repo_path" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
              printf -- "- %s: not available\n" "$repo_name"
              return
            fi

            if ! git -C "$repo_path" rev-parse --verify HEAD >/dev/null 2>&1; then
              printf -- "- %s: not available\n" "$repo_name"
              return
            fi

            local commit_hash
            local commit_date
            local tracked_files
            local top_dirs

            commit_hash=$(git -C "$repo_path" rev-parse --short HEAD)
            commit_date=$(git -C "$repo_path" log -1 --date=iso-strict --pretty=format:"%ad")
            tracked_files=$(git -C "$repo_path" ls-files | wc -l | tr -d ' ')
            top_dirs=$(git -C "$repo_path" ls-tree --name-only HEAD | tr '\n' ',' | sed 's/,$//' | sed 's/,/, /g')

            printf -- "- %s\n" "$repo_name"
            printf "  - commit: %s\n" "$commit_hash"
            printf "  - updated: %s\n" "$commit_date"
            printf "  - tracked files: %s\n" "$tracked_files"
            printf "  - top-level: %s\n" "${top_dirs:-none}"
          }

          build_investing_digest() {
            local posts_dir="investing/_posts"
            if [ ! -d "$posts_dir" ]; then
              printf -- "- latest digest: unavailable\n"
              return
            fi

            local latest_file
            latest_file=$(ls -1 "$posts_dir"/*daily-news-summary*.md 2>/dev/null | tail -n 1 || true)
            if [ -z "$latest_file" ]; then
              printf -- "- latest digest: unavailable\n"
              return
            fi

            local digest_title
            local digest_excerpt
            local digest_url
            local slug
            local y
            local m
            local d
            local rest

            digest_title=$(grep -m1 '^title:' "$latest_file" | sed 's/^title:[[:space:]]*//; s/^"//; s/"$//')
            digest_excerpt=$(grep -m1 '^excerpt:' "$latest_file" | sed 's/^excerpt:[[:space:]]*//; s/^"//; s/"$//')
            digest_excerpt=$(printf "%s" "$digest_excerpt" | cut -c1-160)
            slug=$(basename "$latest_file" .md)
            y=$(printf "%s" "$slug" | cut -d'-' -f1)
            m=$(printf "%s" "$slug" | cut -d'-' -f2)
            d=$(printf "%s" "$slug" | cut -d'-' -f3)
            rest=$(printf "%s" "$slug" | cut -d'-' -f4-)
            if [ -n "$y" ] && [ -n "$m" ] && [ -n "$d" ] && [ -n "$rest" ]; then
              digest_url="https://investing.2twodragon.com/market-analysis/$y/$m/$d/$rest/"
            else
              digest_url="https://investing.2twodragon.com/"
            fi

            printf -- "- latest digest: %s\n" "$digest_title"
            if [ -n "$digest_excerpt" ]; then
              printf "  - summary: %s\n" "$digest_excerpt"
            fi
            printf "  - link: %s\n" "$digest_url"
          }

          report_file="${RUNNER_TEMP}/folder_report.txt"
          {
            printf "*Daily folder report*\n"
            printf -- "- time (UTC): %s\n" "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
            build_investing_digest
            build_line "ai" "ai"
            build_line "investing" "investing"
            build_line "crypto" "crypto"
          } > "$report_file"

          {
            echo "message<<EOF"
            cat "$report_file"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Validate Slack config
        id: slack-config
        shell: bash
        env:
          TARGET_CHANNEL_ALIAS: ${{ matrix.channel_alias }}
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          AI_SLACK_BOT_TOKEN: ${{ secrets.AI_SLACK_BOT_TOKEN }}
          SLACK_TOKEN: ${{ secrets.SLACK_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          AI_SLACK_CHANNEL_ID: ${{ secrets.AI_SLACK_CHANNEL_ID }}
          SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL }}
          SLACK_CHANNEL_ID_OPS: ${{ secrets.SLACK_CHANNEL_ID_OPS }}
          SLACK_CHANNEL_ID_DEV: ${{ secrets.SLACK_CHANNEL_ID_DEV }}
          SLACK_CHANNEL_ID_SECURITY: ${{ secrets.SLACK_CHANNEL_ID_SECURITY }}
          SLACK_CHANNEL_ID_AI: ${{ secrets.SLACK_CHANNEL_ID_AI }}
          SLACK_CHANNEL_ID_INVESTING: ${{ secrets.SLACK_CHANNEL_ID_INVESTING }}
          AI_SLACK_CHANNEL_ID_OPS: ${{ secrets.AI_SLACK_CHANNEL_ID_OPS }}
          AI_SLACK_CHANNEL_ID_DEV: ${{ secrets.AI_SLACK_CHANNEL_ID_DEV }}
          AI_SLACK_CHANNEL_ID_SECURITY: ${{ secrets.AI_SLACK_CHANNEL_ID_SECURITY }}
          AI_SLACK_CHANNEL_ID_AI: ${{ secrets.AI_SLACK_CHANNEL_ID_AI }}
          AI_SLACK_CHANNEL_ID_INVESTING: ${{ secrets.AI_SLACK_CHANNEL_ID_INVESTING }}
          SLACK_CHANNEL_OPS: ${{ secrets.SLACK_CHANNEL_OPS }}
          SLACK_CHANNEL_DEV: ${{ secrets.SLACK_CHANNEL_DEV }}
          SLACK_CHANNEL_SECURITY: ${{ secrets.SLACK_CHANNEL_SECURITY }}
          SLACK_CHANNEL_AI: ${{ secrets.SLACK_CHANNEL_AI }}
          SLACK_CHANNEL_INVESTING: ${{ secrets.SLACK_CHANNEL_INVESTING }}
        run: |
          set -euo pipefail
          can_post=true
          alias="${TARGET_CHANNEL_ALIAS:-investing}"

          bot_token="${SLACK_BOT_TOKEN:-}"
          if [ -z "$bot_token" ]; then
            bot_token="${AI_SLACK_BOT_TOKEN:-}"
          fi
          if [ -z "$bot_token" ]; then
            bot_token="${SLACK_TOKEN:-}"
          fi

          case "$alias" in
            ops)
              channel_id="${SLACK_CHANNEL_ID_OPS:-${AI_SLACK_CHANNEL_ID_OPS:-${SLACK_CHANNEL_OPS:-}}}"
              ;;
            dev)
              channel_id="${SLACK_CHANNEL_ID_DEV:-${AI_SLACK_CHANNEL_ID_DEV:-${SLACK_CHANNEL_DEV:-}}}"
              ;;
            security)
              channel_id="${SLACK_CHANNEL_ID_SECURITY:-${AI_SLACK_CHANNEL_ID_SECURITY:-${SLACK_CHANNEL_SECURITY:-}}}"
              ;;
            ai)
              channel_id="${SLACK_CHANNEL_ID_AI:-${AI_SLACK_CHANNEL_ID_AI:-${SLACK_CHANNEL_AI:-}}}"
              ;;
            investing|*)
              channel_id="${SLACK_CHANNEL_ID_INVESTING:-${AI_SLACK_CHANNEL_ID_INVESTING:-${SLACK_CHANNEL_INVESTING:-${SLACK_CHANNEL_ID:-${AI_SLACK_CHANNEL_ID:-${SLACK_CHANNEL:-}}}}}}"
              ;;
          esac

          if [ -z "$bot_token" ]; then
            echo "No Slack bot token secret found; skip Slack post"
            can_post=false
          fi
          if [ -z "$channel_id" ]; then
            echo "No Slack channel secret found; skip Slack post"
            can_post=false
          fi
          case "$alias" in
            ops)
              profile_label="ops-agent"
              ;;
            dev)
              profile_label="dev-agent"
              ;;
            security)
              profile_label="security-agent"
              ;;
            ai)
              profile_label="ai-agent"
              ;;
            investing|*)
              profile_label="investing-agent"
              ;;
          esac
          echo "can_post=$can_post" >> "$GITHUB_OUTPUT"
          echo "bot_token=$bot_token" >> "$GITHUB_OUTPUT"
          echo "channel_id=$channel_id" >> "$GITHUB_OUTPUT"
          echo "profile_label=$profile_label" >> "$GITHUB_OUTPUT"

      - name: Post to Slack investing channel
        if: steps.slack-config.outputs.can_post == 'true'
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ steps.slack-config.outputs.bot_token }}
          payload: |
            channel: "${{ steps.slack-config.outputs.channel_id }}"
            text: "[${{ steps.slack-config.outputs.profile_label }}]\n${{ steps.summary.outputs.message }}"
