name: Dependency Security Check

on:
  schedule:
    - cron: '0 2 * * 1'  # Every Monday 02:00 UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write

concurrency:
  group: dependency-check
  cancel-in-progress: true

jobs:
  audit:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: scripts/requirements.txt

      - name: Install dependencies
        run: pip install -r scripts/requirements.txt pip-audit

      - name: Run pip-audit
        id: audit
        continue-on-error: true
        run: |
          pip-audit -r scripts/requirements.txt --format=json --output=audit-report.json 2>&1 || true
          pip-audit -r scripts/requirements.txt 2>&1 | tee audit-report.txt

          VULN_COUNT=$(python3 -c "
          import json
          try:
              with open('audit-report.json') as f:
                  data = json.load(f)
              vulns = data.get('dependencies', [])
              count = sum(len(d.get('vulns', [])) for d in vulns)
              print(count)
          except:
              print(0)
          ")
          echo "vuln_count=$VULN_COUNT" >> "$GITHUB_OUTPUT"
          echo "Found $VULN_COUNT vulnerabilities"

      - name: Check outdated packages
        run: pip list --outdated --format=columns 2>/dev/null || true

      - name: Create issue on vulnerabilities
        if: steps.audit.outputs.vuln_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report = 'No details available';
            try {
              report = fs.readFileSync('audit-report.txt', 'utf8');
            } catch (e) {}

            const title = `ðŸ”’ Dependency Security: ${process.env.VULN_COUNT} vulnerabilities found`;
            const body = `## Dependency Security Audit\n\n` +
              `**Vulnerabilities Found**: ${process.env.VULN_COUNT}\n\n` +
              `### Details\n\`\`\`\n${report.substring(0, 3000)}\n\`\`\`\n\n` +
              `*Auto-generated by dependency-check workflow*`;

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security'
            });

            const existing = issues.data.find(i => i.title.includes('Dependency Security'));
            if (!existing) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['security', 'dependencies', 'automated']
              });
            }
        env:
          VULN_COUNT: ${{ steps.audit.outputs.vuln_count }}
